<!-- NeuroPath Modern Navigation Bar with Role-Based Menu -->
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject NavigationManager NavigationManager
@inject HttpClient HttpClient
@inject IJSRuntime JS

<nav class="crh-navbar-v2">
    <div class="crh-navbar-container">
        <!-- Logo & Brand -->
        <a href="/" class="crh-brand">
            <div class="crh-brand-icon">
                <i class="bi bi-brain"></i>
            </div>
            <span class="crh-brand-text">NeuroPath</span>
        </a>

        <!-- Hamburger Menu (Mobile Only) -->
        <button 
            class="crh-hamburger @(isMenuOpen ? "crh-active" : "")"
            @onclick="ToggleNavMenu"
            aria-label="Toggle menu"
            aria-expanded="@isMenuOpen">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <!-- Main Menu - Role Based -->
        <div class="crh-menu @(isMenuOpen ? "crh-open" : "")">
            <!-- Home Link (All Users) -->
            <a href="/" class="crh-nav-item" @onclick="CloseMenu">
                <i class="bi bi-house-fill"></i>
                <span>Home</span>
            </a>

            <!-- Student Menu -->
            @if (userRole == "User")
            {
                <!-- User/Learner -->
                <a href="/games" class="crh-nav-item" @onclick="CloseMenu">
                    <i class="bi bi-controller"></i>
                    <span>Play Games</span>
                </a>
                <a href="/progress" class="crh-nav-item" @onclick="CloseMenu">
                    <i class="bi bi-graph-up"></i>
                    <span>My Progress</span>
                </a>
                <a href="/statistics" class="crh-nav-item" @onclick="CloseMenu">
                    <i class="bi bi-bar-chart"></i>
                    <span>Statistics</span>
                </a>
            }

            <!-- Parent Menu -->
            @if (userRole == "Parent")
            {
                <!-- Parent/Guardian -->
                <a href="/parent-dashboard" class="crh-nav-item" @onclick="CloseMenu">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/children" class="crh-nav-item" @onclick="CloseMenu">
                    <i class="bi bi-people"></i>
                    <span>My Children</span>
                </a>
                <a href="/child-progress" class="crh-nav-item" @onclick="CloseMenu">
                    <i class="bi bi-graph-up"></i>
                    <span>Progress</span>
                </a>
                <a href="/analytics" class="crh-nav-item" @onclick="CloseMenu">
                    <i class="bi bi-bar-chart"></i>
                    <span>Analytics</span>
                </a>
            }

            <!-- Common Links -->
            <a href="/support" class="crh-nav-item" @onclick="CloseMenu">
                <i class="bi bi-question-circle"></i>
                <span>Help & Support</span>
            </a>
        </div>

        <!-- Right Side - User Profile & Actions -->
        <div class="crh-navbar-actions">
            @if (!string.IsNullOrEmpty(username))
            {
                <!-- User Dropdown -->
                <div class="crh-user-menu">
                    <button class="crh-user-btn" @onclick="ToggleUserMenu">
                        <span class="crh-user-avatar">ðŸ‘¤</span>
                        <span class="crh-username">@username</span>
                        <i class="bi bi-chevron-down crh-dropdown-icon @(isUserMenuOpen ? "crh-rotate" : "")"></i>
                    </button>

                    @if (isUserMenuOpen)
                    {
                        <div class="crh-user-dropdown">
                            <div class="crh-user-info">
                                <div class="crh-user-name">@username</div>
                                <div class="crh-user-role">@GetRoleDisplayName(userRole)</div>
                            </div>
                            <hr class="crh-divider" />
                            <a href="/profile" class="crh-dropdown-item" @onclick="CloseUserMenu">
                                <i class="bi bi-person-circle"></i>
                                <span>My Profile</span>
                            </a>
                            <a href="/settings" class="crh-dropdown-item" @onclick="CloseUserMenu">
                                <i class="bi bi-gear"></i>
                                <span>Settings</span>
                            </a>
                            <hr class="crh-divider" />
                            <a href="#" class="crh-dropdown-item crh-logout-btn" @onclick="HandleLogout">
                                <i class="bi bi-box-arrow-right"></i>
                                <span>Logout</span>
                            </a>
                        </div>
                    }
                </div>
            }
            else
            {
                <!-- Login Button (Not Authenticated) -->
                <a href="/login" class="crh-settings-btn">
                    <i class="bi bi-box-arrow-in-right"></i>
                    <span>Login</span>
                </a>
            }
        </div>
    </div>
</nav>

@code {
    private bool isMenuOpen = false;
    private bool isUserMenuOpen = false;
    private string username = "";
    private string userRole = "";

    private bool navBarHasCheckedAuth = false;
    private EventHandler<LocationChangedEventArgs>? locationChangedHandler;

    // Defer JS interop until after first render to avoid prerender-time JS errors
    protected override Task OnInitializedAsync()
    {
        // Register for location changes
        locationChangedHandler = async (sender, e) => await OnLocationChanged(sender, e);
        NavigationManager.LocationChanged += locationChangedHandler;
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !navBarHasCheckedAuth)
        {
            navBarHasCheckedAuth = true;
            await LoadUserInfo();
        }
    }

    private async Task OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        // Refresh user info whenever the location changes (after login redirect)
        // Add a small delay to ensure localStorage is updated
        await Task.Delay(100);
        await LoadUserInfo();
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (locationChangedHandler != null)
        {
            NavigationManager.LocationChanged -= locationChangedHandler;
        }
        await Task.CompletedTask;
    }

    private async Task LoadUserInfo()
    {
        try
        {
            // Load user info from browser LocalStorage using JS interop
            var newUsername = await JS.InvokeAsync<string>("localStorage.getItem", "username") ?? "";
            var newUserRole = await JS.InvokeAsync<string>("localStorage.getItem", "userRole") ?? "";
            
            // Only update if values changed
            if (newUsername != username || newUserRole != userRole)
            {
                username = newUsername;
                userRole = newUserRole;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user info: {ex.Message}");
        }
    }

    private void ToggleNavMenu()
    {
        isMenuOpen = !isMenuOpen;
    }

    private void CloseMenu()
    {
        isMenuOpen = false;
    }

    private void ToggleUserMenu()
    {
        isUserMenuOpen = !isUserMenuOpen;
    }

    private void CloseUserMenu()
    {
        isUserMenuOpen = false;
    }

    private async Task HandleLogout()
    {
        try
        {
            // Clear LocalStorage using JS interop
            await JS.InvokeVoidAsync("localStorage.removeItem", "authToken");
            await JS.InvokeVoidAsync("localStorage.removeItem", "userId");
            await JS.InvokeVoidAsync("localStorage.removeItem", "userRole");
            await JS.InvokeVoidAsync("localStorage.removeItem", "username");
            
            // Reset state
            username = "";
            userRole = "";
            isUserMenuOpen = false;
            
            // Redirect to login
            NavigationManager.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during logout: {ex.Message}");
        }
    }

    private string GetRoleDisplayName(string role)
    {
        return role switch
        {
            "User" => "Student/Learner",
            "Parent" => "Parent/Guardian",
            _ => "User"
        };
    }
}

<!-- ============================================================================
     EMBEDDED STYLES - NeuroPath Navigation v2 (Self-Contained)
     ============================================================================ -->

<style>
    /* ========== COLOR PALETTE ========== */
    :root {
        --crh-primary: #6366f1;
        --crh-primary-dark: #4f46e5;
        --crh-primary-light: #818cf8;
        --crh-secondary: #06b6d4;
        --crh-text-dark: #111827;
        --crh-text-base: #374151;
        --crh-text-muted: #6b7280;
        --crh-bg-white: #ffffff;
        --crh-bg-light: #f9fafb;
        --crh-border: #e5e7eb;
        --crh-shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --crh-shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
        --crh-shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
        --crh-transition: 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========== NAVBAR CONTAINER ========== */
    .crh-navbar-v2 {
        background-color: var(--crh-bg-white);
        border-bottom: 1px solid var(--crh-border);
        box-shadow: var(--crh-shadow-md);
        position: sticky;
        top: 0;
        z-index: 1000;
        width: 100%;
    }

    .crh-navbar-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0.875rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 2rem;
        width: 100%;
    }

    /* ========== BRAND/LOGO ========== */
    .crh-brand {
        display: flex;
        align-items: center;
        gap: 0.875rem;
        text-decoration: none;
        font-weight: 700;
        font-size: 1.375rem;
        color: var(--crh-text-dark);
        flex-shrink: 0;
        transition: all var(--crh-transition);
    }

    .crh-brand:hover,
    .crh-brand:focus {
        color: var(--crh-primary);
    }

    .crh-brand-icon {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, var(--crh-primary) 0%, var(--crh-secondary) 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.375rem;
        box-shadow: var(--crh-shadow-md);
    }

    .crh-brand-text {
        background: linear-gradient(135deg, var(--crh-primary) 0%, var(--crh-secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* ========== MAIN MENU (DESKTOP HORIZONTAL) ========== */
    .crh-menu {
        display: flex;
        align-items: center;
        gap: 0;
        flex: 1;
        justify-content: flex-start;
    }

    /* ========== NAVIGATION ITEMS ========== */
    .crh-nav-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        color: var(--crh-text-muted);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9375rem;
        background: none;
        border: none;
        cursor: pointer;
        font-family: inherit;
        border-radius: 8px;
        transition: all var(--crh-transition);
        white-space: nowrap;
    }

    .crh-nav-item:hover,
    .crh-nav-item:focus {
        color: var(--crh-primary);
        background-color: rgba(99, 102, 241, 0.08);
    }

    .crh-nav-item i {
        font-size: 1.125rem;
        display: inline-flex;
        align-items: center;
    }

    /* ========== DROPDOWN ========== */
    .crh-nav-dropdown {
        position: relative;
    }

    .crh-dropdown-toggle {
        position: relative;
    }

    .crh-chevron {
        transition: transform var(--crh-transition);
        font-size: 0.75rem;
        margin-left: 0.25rem;
    }

    .crh-chevron.crh-rotate {
        transform: rotate(180deg);
    }

    .crh-dropdown-menu {
        display: none;
        position: absolute;
        top: calc(100% + 0.5rem);
        left: 0;
        background: var(--crh-bg-white);
        border: 1px solid var(--crh-border);
        border-radius: 12px;
        box-shadow: var(--crh-shadow-lg);
        min-width: 260px;
        z-index: 1001;
        overflow: hidden;
    }

    .crh-dropdown-menu.crh-show {
        display: block;
    }

    .crh-dropdown-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        color: var(--crh-text-base);
        text-decoration: none;
        transition: all var(--crh-transition);
        border-left: 4px solid transparent;
        border-bottom: 1px solid var(--crh-border);
    }

    .crh-dropdown-item:last-child {
        border-bottom: none;
    }

    .crh-dropdown-item:hover {
        background-color: var(--crh-bg-light);
        color: var(--crh-primary);
        border-left-color: var(--crh-primary);
    }

    .crh-dropdown-item i {
        font-size: 1.25rem;
        flex-shrink: 0;
        min-width: 24px;
    }

    .crh-item-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .crh-item-name {
        font-weight: 500;
        font-size: 0.9375rem;
    }

    /* ========== BADGES ========== */
    .crh-badge {
        font-size: 0.65rem;
        padding: 0.25rem 0.625rem;
        border-radius: 4px;
        font-weight: 700;
        white-space: nowrap;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
    }

    .crh-badge-primary {
        background-color: #dbeafe;
        color: #0c4a6e;
    }

    .crh-badge-success {
        background-color: #dcfce7;
        color: #166534;
    }

    .crh-badge-warning {
        background-color: #fed7aa;
        color: #92400e;
    }

    /* ========== NAVBAR ACTIONS (SETTINGS) ========== */
    .crh-navbar-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-left: auto;
        flex-shrink: 0;
    }

    .crh-settings-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        background-color: var(--crh-bg-light);
        color: var(--crh-text-muted);
        border: 1px solid var(--crh-border);
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9375rem;
        cursor: pointer;
        font-family: inherit;
        transition: all var(--crh-transition);
    }

    .crh-settings-btn:hover,
    .crh-settings-btn:focus {
        background-color: var(--crh-border);
        color: var(--crh-primary);
        border-color: var(--crh-primary);
    }

    /* ========== HAMBURGER MENU (MOBILE) ========== */
    .crh-hamburger {
        display: none;
        flex-direction: column;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem;
        gap: 0.375rem;
        margin-left: auto;
    }

    .crh-hamburger span {
        width: 24px;
        height: 2.5px;
        background-color: var(--crh-text-dark);
        border-radius: 2px;
        transition: all var(--crh-transition);
    }

    .crh-hamburger.crh-active span:nth-child(1) {
        transform: translateY(8px) rotate(45deg);
    }

    .crh-hamburger.crh-active span:nth-child(2) {
        opacity: 0;
    }

    .crh-hamburger.crh-active span:nth-child(3) {
        transform: translateY(-8px) rotate(-45deg);
    }

    /* ========== RESPONSIVE: TABLET (1024px and below) ========== */
    @@media (max-width: 1024px) {
        .crh-navbar-container {
            padding: 0.75rem 1rem;
            gap: 1rem;
        }

        .crh-menu {
            gap: 0.25rem;
        }

        .crh-nav-item {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        .crh-navbar-actions {
            margin-left: 0.5rem;
        }

        .crh-settings-btn span {
            display: none;
        }
    }

    /* ========== RESPONSIVE: MOBILE (768px and below) ========== */
    @@media (max-width: 768px) {
        .crh-navbar-container {
            flex-wrap: wrap;
            padding: 0.75rem 1rem;
            gap: 0;
        }

        /* Show hamburger on mobile */
        .crh-hamburger {
            display: flex;
            order: 10;
        }

        /* Mobile menu - vertical layout, hidden by default */
        .crh-menu {
            order: 20;
            flex-direction: column;
            gap: 0;
            width: 100%;
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--crh-transition);
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--crh-border);
        }

        /* Show menu when open */
        .crh-menu.crh-open {
            max-height: 600px;
            overflow-y: auto;
        }

        .crh-nav-item {
            width: 100%;
            padding: 0.75rem 0;
            border-radius: 0;
            border-left: 4px solid transparent;
        }

        .crh-nav-item:hover,
        .crh-nav-item:focus {
            background-color: transparent;
            border-left-color: var(--crh-primary);
        }

        /* Mobile dropdown */
        .crh-dropdown-menu {
            position: static;
            display: none;
            border: none;
            box-shadow: none;
            background-color: var(--crh-bg-light);
            min-width: auto;
            margin-top: 0.5rem;
        }

        .crh-dropdown-menu.crh-show {
            display: block;
        }

        .crh-dropdown-item {
            padding: 0.75rem 0;
            border-left: none;
            border-bottom: none;
            font-size: 0.875rem;
        }

        .crh-dropdown-item:hover {
            border-left: none;
        }

        /* Settings button on mobile */
        .crh-navbar-actions {
            order: 30;
            width: 100%;
            margin-left: 0;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--crh-border);
        }

        .crh-settings-btn span {
            display: inline;
        }

        /* Brand positioning */
        .crh-brand {
            order: 1;
            flex: 1;
        }
    }

    /* ========== RESPONSIVE: SMALL MOBILE (480px and below) ========== */
    @@media (max-width: 480px) {
        .crh-navbar-container {
            padding: 0.625rem 0.75rem;
        }

        .crh-brand-text {
            display: none;
        }

        .crh-brand-icon {
            width: 36px;
            height: 36px;
            font-size: 1rem;
        }

        .crh-brand {
            font-size: 1rem;
            gap: 0.5rem;
        }

        .crh-nav-item {
            padding: 0.5rem 0;
            font-size: 0.8125rem;
        }

        .crh-badge {
            font-size: 0.6rem;
            padding: 0.2rem 0.5rem;
        }
    }

    /* ========== ACCESSIBILITY ========== */
    .crh-nav-item:focus-visible,
    .crh-settings-btn:focus-visible,
    .crh-dropdown-toggle:focus-visible {
        outline: 2px solid var(--crh-primary);
        outline-offset: 2px;
    }

    /* ========== USER MENU DROPDOWN ========== */
    .crh-user-menu {
        position: relative;
        display: flex;
        align-items: center;
    }

    .crh-user-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.75rem;
        background: none;
        border: 1px solid var(--crh-border);
        border-radius: 8px;
        cursor: pointer;
        color: var(--crh-text-base);
        font-family: inherit;
        font-size: 0.9375rem;
        font-weight: 500;
        transition: all var(--crh-transition);
    }

    .crh-user-btn:hover {
        background-color: var(--crh-bg-light);
        border-color: var(--crh-primary);
        color: var(--crh-primary);
    }

    .crh-user-avatar {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--crh-primary) 0%, var(--crh-secondary) 100%);
        border-radius: 50%;
        color: white;
        font-size: 1rem;
        flex-shrink: 0;
    }

    .crh-username {
        font-weight: 600;
        color: var(--crh-text-dark);
    }

    .crh-dropdown-icon {
        font-size: 0.75rem;
        transition: transform var(--crh-transition);
        margin-left: 0.25rem;
    }

    .crh-dropdown-icon.crh-rotate {
        transform: rotate(180deg);
    }

    .crh-user-dropdown {
        position: absolute;
        top: calc(100% + 0.5rem);
        right: 0;
        background: var(--crh-bg-white);
        border: 1px solid var(--crh-border);
        border-radius: 12px;
        box-shadow: var(--crh-shadow-lg);
        min-width: 260px;
        z-index: 1001;
        overflow: hidden;
        animation: slideDown 200ms ease-out;
    }

    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .crh-user-info {
        padding: 1rem;
        background: var(--crh-bg-light);
        border-bottom: 1px solid var(--crh-border);
    }

    .crh-user-name {
        font-weight: 600;
        color: var(--crh-text-dark);
        font-size: 0.9375rem;
    }

    .crh-user-role {
        font-size: 0.8125rem;
        color: var(--crh-text-muted);
        margin-top: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .crh-divider {
        margin: 0;
        border: none;
        border-top: 1px solid var(--crh-border);
    }

    .crh-dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        color: var(--crh-text-base);
        text-decoration: none;
        font-size: 0.9375rem;
        border: none;
        background: none;
        cursor: pointer;
        font-family: inherit;
        width: 100%;
        text-align: left;
        transition: all var(--crh-transition);
        border-left: 4px solid transparent;
    }

    .crh-dropdown-item:hover {
        background-color: var(--crh-bg-light);
        color: var(--crh-primary);
        border-left-color: var(--crh-primary);
    }

    .crh-dropdown-item i {
        font-size: 1.125rem;
        flex-shrink: 0;
        min-width: 20px;
    }

    .crh-dropdown-item span {
        flex: 1;
    }

    .crh-logout-btn {
        color: #dc2626;
    }

    .crh-logout-btn:hover {
        background-color: #fee2e2;
        color: #991b1b;
        border-left-color: #dc2626;
    }

    /* Reduced motion support */
    @@media (prefers-reduced-motion: reduce) {
        .crh-nav-item,
        .crh-settings-btn,
        .crh-chevron,
        .crh-menu,
        .crh-hamburger span,
        .crh-user-dropdown {
            transition: none !important;
            animation: none !important;
        }
    }

    /* ========== RESPONSIVE: MOBILE USER MENU ========== */
    @@media (max-width: 768px) {
        .crh-user-menu {
            width: 100%;
            order: 40;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--crh-border);
        }

        .crh-user-btn {
            width: 100%;
            justify-content: space-between;
        }

        .crh-user-dropdown {
            position: static;
            border: none;
            box-shadow: none;
            min-width: auto;
            margin-top: 0.5rem;
            display: none;
        }

        .crh-user-dropdown.crh-open {
            display: block;
        }

        .crh-dropdown-item {
            border-left: none;
        }

        .crh-dropdown-item:hover {
            border-left: none;
        }
    }
</style>
