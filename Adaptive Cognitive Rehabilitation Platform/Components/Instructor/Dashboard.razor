@page "/instructor-dashboard"
@rendermode InteractiveServer
@using System.Net.Http.Json
@using System.Net.Http.Headers
@using Microsoft.JSInterop
@implements IAsyncDisposable
@implements IDisposable
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<!-- Dashboard Container -->
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1><i class="bi bi-bar-chart"></i> Instructor Dashboard</h1>
            <p class="text-muted">Monitor student progress and manage therapy sessions</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" @onclick="RefreshDashboard">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button class="btn btn-outline-primary">
                <i class="bi bi-download"></i> Export Report
            </button>
        </div>
    </div>

    <!-- Loading State -->
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading dashboard data...</p>
            <small class="text-muted">(Timeout in 15 seconds if it takes too long)</small>
        </div>
    }
    else if (!string.IsNullOrEmpty(loadError))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> <strong>Error:</strong> @loadError
            <button type="button" class="btn-close" @onclick="@(() => loadError = string.Empty)"></button>
        </div>
        <div class="text-center mt-3">
            <button class="btn btn-primary" @onclick="RefreshDashboard">
                <i class="bi bi-arrow-clockwise"></i> Retry
            </button>
        </div>
    }
    else if (students == null || students.Count == 0)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No students assigned yet.
        </div>
    }
    else
    {
        <!-- Statistics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon bg-primary"><i class="bi bi-people-fill"></i></div>
                    <div class="stat-content">
                        <h6 class="stat-label">Total Students</h6>
                        <h3 class="stat-value">@students.Count</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon bg-success"><i class="bi bi-check-circle-fill"></i></div>
                    <div class="stat-content">
                        <h6 class="stat-label">Sessions Completed</h6>
                        <h3 class="stat-value">@totalSessionsCompleted</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon bg-warning"><i class="bi bi-graph-up"></i></div>
                    <div class="stat-content">
                        <h6 class="stat-label">Avg Accuracy</h6>
                        <h3 class="stat-value">@averageAccuracy.ToString("F1")%</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon bg-info"><i class="bi bi-target"></i></div>
                    <div class="stat-content">
                        <h6 class="stat-label">Active Assignments</h6>
                        <h3 class="stat-value">@activeAssignments</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters & Search -->
        <div class="filters-section mb-4">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="Search students..." 
                               @oninput="@((ChangeEventArgs e) => OnSearchChanged(e.Value?.ToString() ?? ""))">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" @onchange="@OnFilterChanged">
                        <option value="">All Difficulties</option>
                        <option value="1">Beginner (1)</option>
                        <option value="2">Intermediate (2)</option>
                        <option value="3">Advanced (3)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" @onchange="@OnSortChanged">
                        <option value="name">Sort by Name</option>
                        <option value="accuracy">Sort by Accuracy</option>
                        <option value="sessions">Sort by Sessions</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Students Grid -->
        <div class="row">
            @foreach (var student in filteredStudents)
            {
                <div class="col-lg-6 col-xl-4 mb-4">
                    <!-- StudentCard Component (To be implemented) -->
                    <!-- <StudentCard 
                        Student="@student" 
                        OnViewDetails="@((StudentData s) => ViewStudentDetails(s))"
                        OnAssignGame="@((StudentData s) => AssignNewGame(s))" /> -->
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">@student.Name</h5>
                            <p class="card-text text-muted">@student.Condition</p>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Student Details Modal -->
    @if (selectedStudent != null)
    {
        <!-- StudentDetailsModal Component (To be implemented) -->
        <!-- <StudentDetailsModal 
            Student="@selectedStudent" 
            OnClose="@(() => selectedStudent = null)"
            OnUpdate="@RefreshDashboard" /> -->
        <div class="alert alert-info">Student details modal - To be implemented</div>
    }
</div>

<!-- Auto-refresh timer -->
@code {
    private List<StudentData> students = new();
    private List<StudentData> filteredStudents = new();
    private StudentData? selectedStudent;
    private bool isLoading = true;
    private string searchTerm = "";
    private string filterDifficulty = "";
    private string sortBy = "name";
    private int totalSessionsCompleted = 0;
    private double averageAccuracy = 0;
    private int activeAssignments = 0;
    private int trainerId = 0;
    private System.Timers.Timer? refreshTimer;
    private bool isDisposed = false;  // ← Track disposal state
    private CancellationTokenSource? loadCts; // ← Request timeout
    private string loadError = ""; // ← Error message display

    private bool instructorHasInitialized = false;
    private const int REQUEST_TIMEOUT_MS = 15000; // 15 second timeout

    // Defer LocalStorage access to OnAfterRenderAsync so JS interop is available
    protected override Task OnInitializedAsync()
    {
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !instructorHasInitialized)
        {
            instructorHasInitialized = true;
            try
            {
                // Get trainer ID from LocalStorage
                var trainerIdStr = await JS.InvokeAsync<string>("localStorage.getItem", "userId");
                if (int.TryParse(trainerIdStr, out var id))
                {
                    trainerId = id;
                }

                // Load initial data
                await LoadDashboardData();

                // Set up auto-refresh (every 30 seconds)
                refreshTimer = new System.Timers.Timer(30000);
                refreshTimer.Elapsed += async (s, e) => 
                {
                    // Wrap timer event to prevent calls after disposal
                    if (!isDisposed)
                    {
                        try
                        {
                            await RefreshDashboardTimer();
                        }
                        catch (ObjectDisposedException)
                        {
                            // Stop timer if circuit is disposed
                            refreshTimer?.Stop();
                            isDisposed = true;
                        }
                    }
                };
                refreshTimer.AutoReset = true;
                refreshTimer.Start();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing dashboard: {ex.Message}");
            }
        }
    }

    private async Task LoadDashboardData()
    {
        try
        {
            // Check if component is disposed before using JS interop
            if (isDisposed)
            {
                Console.WriteLine("Dashboard component is disposed, skipping data load");
                return;
            }

            isLoading = true;
            loadError = "";
            StateHasChanged();

            var baseUrl = NavigationManager.BaseUri;
            
            // Get JWT token from localStorage - wrapped in try-catch for safety
            string? token = null;
            try
            {
                token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
            }
            catch (JSDisconnectedException)
            {
                Console.WriteLine("JS circuit disconnected while retrieving token");
                isDisposed = true;
                return;
            }
            catch (TaskCanceledException)
            {
                Console.WriteLine("Token retrieval timed out");
                loadError = "Request timed out. Please refresh the page.";
                isLoading = false;
                StateHasChanged();
                return;
            }
            
            // Add token to Authorization header if present
            if (!string.IsNullOrEmpty(token))
            {
                HttpClient.DefaultRequestHeaders.Authorization = 
                    new AuthenticationHeaderValue("Bearer", token);
                Console.WriteLine("JWT token added to request headers");
            }
            else
            {
                Console.WriteLine("Warning: No JWT token found in localStorage");
                loadError = "Authentication required. Please login again.";
                isLoading = false;
                StateHasChanged();
                return;
            }

            // Create cancellation token with timeout
            loadCts?.Dispose();
            loadCts = new CancellationTokenSource(REQUEST_TIMEOUT_MS);

            try
            {
                // Fetch students assigned to this trainer WITH TIMEOUT
                var response = await HttpClient.GetAsync(
                    $"{baseUrl}api/instructor/students/{trainerId}", 
                    HttpCompletionOption.ResponseContentRead,
                    loadCts.Token);
                
                if (response.IsSuccessStatusCode)
                {
                    var data = await response.Content.ReadFromJsonAsync<DashboardDataResponse>(cancellationToken: loadCts.Token);
                    
                    students = data?.Students ?? new List<StudentData>();
                    totalSessionsCompleted = data?.TotalSessionsCompleted ?? 0;
                    averageAccuracy = data?.AverageAccuracy ?? 0;
                    activeAssignments = data?.ActiveAssignments ?? 0;

                    ApplyFiltersAndSort();
                    Console.WriteLine($"Dashboard loaded: {students.Count} students, {totalSessionsCompleted} sessions");
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    var statusMsg = $"Status: {response.StatusCode} ({response.ReasonPhrase})";
                    Console.WriteLine($"Failed to load dashboard data - {statusMsg}");
                    Console.WriteLine($"Error details: {errorContent}");
                    loadError = $"Failed to load dashboard ({response.StatusCode}). Please try again.";
                }
            }
            catch (OperationCanceledException)
            {
                Console.WriteLine("Dashboard request timed out after 15 seconds");
                loadError = "Request took too long. Please refresh the page and try again.";
            }
        }
        catch (JSDisconnectedException ex)
        {
            Console.WriteLine($"JS Disconnected Exception: {ex.Message}");
            isDisposed = true;
        }
        catch (ObjectDisposedException ex)
        {
            Console.WriteLine($"Object Disposed Exception: {ex.Message}");
            isDisposed = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard data: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            loadError = $"Error loading dashboard: {ex.Message}";
        }
        finally
        {
            if (!isDisposed)
            {
                isLoading = false;
            }
            StateHasChanged();
        }
    }

    private void ApplyFiltersAndSort()
    {
        // Apply search
        filteredStudents = students
            .Where(s => string.IsNullOrEmpty(searchTerm) || 
                   s.ProfileName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                   s.Username.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
            .ToList();

        // Apply difficulty filter
        if (!string.IsNullOrEmpty(filterDifficulty) && int.TryParse(filterDifficulty, out var difficulty))
        {
            filteredStudents = filteredStudents.Where(s => s.CurrentDifficultyLevel == difficulty).ToList();
        }

        // Apply sorting
        filteredStudents = sortBy switch
        {
            "accuracy" => filteredStudents.OrderByDescending(s => s.AverageAccuracy).ToList(),
            "sessions" => filteredStudents.OrderByDescending(s => s.TotalSessionsCompleted).ToList(),
            _ => filteredStudents.OrderBy(s => s.ProfileName).ToList()
        };
    }

    private void OnSearchChanged(string term)
    {
        searchTerm = term;
        ApplyFiltersAndSort();
    }

    private void OnFilterChanged(ChangeEventArgs e)
    {
        filterDifficulty = e.Value?.ToString() ?? "";
        ApplyFiltersAndSort();
    }

    private void OnSortChanged(ChangeEventArgs e)
    {
        sortBy = e.Value?.ToString() ?? "name";
        ApplyFiltersAndSort();
    }

    private void ViewStudentDetails(StudentData student)
    {
        selectedStudent = student;
    }

    private async Task AssignNewGame(StudentData student)
    {
        // TODO: Open modal to assign game
        Console.WriteLine($"Assigning game to {student.Username}");
    }

    private async Task RefreshDashboard()
    {
        await LoadDashboardData();
    }

    private async Task RefreshDashboardTimer()
    {
        try
        {
            // ← NEW: Stop the timer if component is being disposed
            if (isDisposed)
            {
                refreshTimer?.Stop();
                return;
            }

            // Wrap with try-catch to handle circuit disconnection gracefully
            await InvokeAsync(async () => 
            {
                if (!isDisposed)
                {
                    await LoadDashboardData();
                }
            });
        }
        catch (ObjectDisposedException)
        {
            // Circuit was disposed, stop the timer
            Console.WriteLine("Circuit disconnected, stopping dashboard refresh timer");
            if (refreshTimer != null)
            {
                refreshTimer.Stop();
            }
            isDisposed = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in RefreshDashboardTimer: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            // Mark as disposed first to prevent JS interop calls
            isDisposed = true;
            
            // Stop and dispose the timer
            if (refreshTimer != null)
            {
                refreshTimer.Stop();
                refreshTimer.Dispose();
            }
            
            // Cancel and dispose any pending requests
            loadCts?.Cancel();
            loadCts?.Dispose();
            
            Console.WriteLine("Dashboard component disposed (async)");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during async disposal: {ex.Message}");
        }
    }

    public void Dispose()
    {
        try
        {
            // Mark as disposed first to prevent JS interop calls
            isDisposed = true;
            
            // Stop and dispose the timer
            if (refreshTimer != null)
            {
                refreshTimer.Stop();
                refreshTimer.Dispose();
            }
            
            // Cancel and dispose any pending requests
            loadCts?.Cancel();
            loadCts?.Dispose();
            
            Console.WriteLine("Dashboard component disposed (sync)");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during sync disposal: {ex.Message}");
        }
    }

    // Data Models
    public class StudentData
    {
        public int UserId { get; set; }
        public int ProfileId { get; set; }
        public string Username { get; set; } = "";
        public string Email { get; set; } = "";
        public string ProfileName { get; set; } = "";
        public int Age { get; set; }
        public string CognitiveLevel { get; set; } = "";
        public string DiagnosedCondition { get; set; } = "";
        public string TherapyGoal { get; set; } = "";
        public int CurrentDifficultyLevel { get; set; }
        public int TotalSessionsCompleted { get; set; }
        public double AverageAccuracy { get; set; }
        public DateTime LastSessionDate { get; set; }
        
        // Aliases for compatibility
        public string Name => Username;
        public string Condition => DiagnosedCondition;
        public List<GameSessionSummary> RecentSessions { get; set; } = new();
        public List<AIAnalysisSummary> LatestAnalyses { get; set; } = new();
        public List<GameAssignmentSummary> ActiveAssignments { get; set; } = new();
    }

    public class GameSessionSummary
    {
        public int SessionId { get; set; }
        public string GameType { get; set; } = "";
        public double Accuracy { get; set; }
        public int PerformanceScore { get; set; }
        public DateTime TimeCompleted { get; set; }
    }

    public class AIAnalysisSummary
    {
        public int AnalysisId { get; set; }
        public string Message { get; set; } = "";
        public double ConfidenceScore { get; set; }
        public List<string> Strengths { get; set; } = new();
        public List<string> Weaknesses { get; set; } = new();
        public List<string> Recommendations { get; set; } = new();
    }

    public class GameAssignmentSummary
    {
        public int AssignmentId { get; set; }
        public string GameType { get; set; } = "";
        public int Difficulty { get; set; }
        public string Status { get; set; } = "";
        public DateTime DueDate { get; set; }
        public double? TargetScore { get; set; }
        public double? ActualScore { get; set; }
    }

    public class DashboardDataResponse
    {
        public List<StudentData> Students { get; set; } = new();
        public int TotalSessionsCompleted { get; set; }
        public double AverageAccuracy { get; set; }
        public int ActiveAssignments { get; set; }
    }
}

<style>
.dashboard-container {
    padding: 30px 20px;
    background-color: #f8f9fa;
    min-height: calc(100vh - 80px);
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.page-header h1 {
    margin: 0;
    font-size: 28px;
    font-weight: 700;
    color: #2c3e50;
}

.page-header .text-muted {
    margin: 5px 0 0 0;
}

.header-actions {
    display: flex;
    gap: 10px;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.stat-icon {
    font-size: 32px;
    width: 60px;
    height: 60px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.stat-icon.bg-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.stat-icon.bg-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.stat-icon.bg-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.stat-icon.bg-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.stat-label {
    color: #95a5a6;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    margin: 0;
}

.stat-value {
    color: #2c3e50;
    font-size: 24px;
    font-weight: 700;
    margin: 0;
}

.filters-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.input-group-text {
    background: #f8f9fa;
    border: 2px solid #ecf0f1;
}

.form-control,
.form-select {
    border: 2px solid #ecf0f1;
    transition: all 0.3s ease;
}

.form-control:focus,
.form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

@@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        gap: 15px;
    }

    .header-actions {
        flex-direction: column;
    }
}
</style>
